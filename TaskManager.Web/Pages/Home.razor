@using Domain.Enums
@using Domain.Model
@using TaskManager.Web.Components
@inject TaskApiService taskApiService
@inject UserApiService userApiService

@attribute [Authorize]
@page "/"

<PageTitle>Home</PageTitle>

<div class="container py-4">
    <h1 class="mb-4">Task Tracker</h1>

    <CreateTaskModal @ref="ModalRef" OnTaskCreated="AddTask" />
    <ViewTaskModal @ref="ViewModal" OnTaskUpdated="SaveTask" OnTaskDeleted="DeleteTask" />
    <!-- Filters -->
    <div class="row mb-4">
        <div class="col-md-3">
            <input class="form-control" placeholder="Filter by user" @bind="FilterUser">
        </div>
        <div class="col-md-3">
            <select class="form-select" @bind="FilterStatus">
                <option value="">All Statuses</option>
                <option value="Created">Created</option>
                <option value="InProgress">In Progress</option>
                <option value="Completed">Completed</option>
            </select>
        </div>
        <div class="col-md-3">
            <input class="form-control" type="date" @bind="FilterDate">
        </div>
        <div class="col-md-3 text-end">
            <button class="btn btn-primary" @onclick="() => ModalRef.Show()">+ New Task</button>
        </div>
    </div>

    <div class="row">
        @foreach (var status in Enum.GetValues(typeof(StatusTask)))
        {
            <Dropzone Items="AllTasks.Where(x => x.Status == (StatusTask)status).ToList()" TItem="TaskItem" OnItemDrop="@((i)=>OnDrop(i, (StatusTask)status))" Class="col-md-4 drop-zone border rounded p-2">
                <ChildContent>
                    <div class="card task-card mb-3" @onclick="() => OpenViewModal(context)">
                        <div class="card-body">
                            <h5 class="card-title">@context.Title</h5>
                            <h6 class="card-subtitle mb-2 text-muted">@context.CreatedByUserId</h6>
                            <p class="card-text">@context.Description</p>
                            <span class="badge bg-secondary">@context.Status</span>
                            <p class="mt-2 small text-muted">Created: @context.CreatedAt.ToShortDateString()</p>
                        </div>
                    </div>
                </ChildContent>
            </Dropzone>
        }
    </div>
</div>

@code {
    string? FilterUser;
    string? FilterStatus;
    DateTime? FilterDate;
    Guid DraggedTaskId;
    User CurrentUser = new User();

    protected override async Task OnInitializedAsync()
    {
        AllTasks = (await taskApiService.GetTasksAsync())?.ToList();
        CurrentUser = await userApiService.GetCurrentUserAsync();
    }

    readonly Dictionary<StatusTask, string> statusLabels = new()
    {
        { StatusTask.Created, "Created" },
        { StatusTask.InProgress, "In Progress" },
        { StatusTask.Done, "Completed" }
    };
    private CreateTaskModal? ModalRef;

    private async Task AddTask(TaskItem newTask)
    {
        AllTasks.Add(await taskApiService.CreateTaskAsync(newTask));
        StateHasChanged();
    }

    private ViewTaskModal? ViewModal;

    private async Task OpenViewModal(TaskItem task)
    {
        ViewModal!.Task = task;
        ViewModal.Show();
    }

    private async Task SaveTask(TaskItem task)
    {
        await taskApiService.UpdateTaskAsync(task.Id, task);
    }
    private async Task DeleteTask(TaskItem task)
    {
        await taskApiService.DeleteTaskAsync(task.Id);
        AllTasks.Remove(task);
        StateHasChanged();
    }

    List<TaskItem> AllTasks = new();

    IEnumerable<TaskItem> FilteredTasks => AllTasks
    .Where(t => string.IsNullOrWhiteSpace(FilterStatus) || t.Status == Enum.Parse<StatusTask>(FilterStatus))
    .Where(t => FilterDate == null || t.CreatedAt.Date == FilterDate.Value.Date);

    void OnDragStart(DragEventArgs e, Guid taskId)
    {
        DraggedTaskId = taskId;
    }

    void OnDrop(TaskItem task, StatusTask newStatus)
    {
        if (task is not null && task.Status != newStatus)
        {
            task.Status = newStatus;
        }

        StateHasChanged();
    }

    RenderFragment<TaskItem> TaskCard => task => @<div class="card task-card mb-3">
        <div class="card-body">
            <h5 class="card-title">@task.Title</h5>
            <h6 class="card-subtitle mb-2 text-muted">@task.CreatedByUserId</h6>
            <p class="card-text">@task.Description</p>
            <span class="badge bg-secondary">@task.Status</span>
            <p class="mt-2 small text-muted">Created: @task.CreatedAt.ToShortDateString()</p>
        </div>
    </div>;
}